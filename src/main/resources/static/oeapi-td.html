<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8" />

<title>OEAPI Courses Overview</title>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/init.js"></script>
<script src="js/oeapi.js"></script>

<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.2/css/bootstrap.min.css' />
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.5.0/css/all.min.css' />

<style>
	.navbar .nav-link#logoutLink,
		.navbar .nav-link#changePasswordLink {
			font-weight: bold;
			color: #fff !important;
		}
		.dropdown-menu {
			position: absolute;
			z-index: 1000;
			display: none;
			/* min-width: 100rem; */
			padding: .5rem 0;
			margin: 0 0 0 -3rem;
			font-size: 1rem;
			color: #212529;
			text-align: left;
			list-style: none;
			background-color: #fff;
			background-clip: padding-box;
			border: 1px solid rgba(0,0,0,.15);
			border-radius: .25rem;
		}
</style>

</head>

<body class="bg-light p-4">

<!-- Navbar -->
<nav id="main-navbar" class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
	<!--<nav class="navbar navbar-expand-lg navbar-dark bg-primary">-->
	<div class="container-fluid">
		<a class="navbar-brand" href="#">OEAPI Tiny Dashboard (Beta)</a>
		<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarContent">
			<!--<ul class="navbar-nav ms-auto"> -->
			<ul class="navbar-nav ms-auto d-flex flex-row">
				<li class="nav-item">
					<a class="nav-link active" href="oeapi-td.html">OEAPI Overview</a>
				</li>

                                <li class="nav-item dropdown">
                                  <a class="nav-link dropdown-toggle" href="#" id="addCoursesLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Add Courses
                                  </a>
                                  <ul class="dropdown-menu" style="font-size: 0.9rem;" aria-labelledby="addCoursesLink">
                                    <li><a class="dropdown-item py-1" href="./courseForm.html">Course and Microcredentials</a></li>
                                    <li><a class="dropdown-item py-1" href="./bipForm.html">Bips</a></li>
                                  </ul>
                                </li>                         

				<li class="nav-item">
					<a class="nav-link" href="catalog.html">My OEAPI as Course Catalog</a>
				</li>

				<li class="nav-item">
					<a class="nav-link" href="backup.html">Backup</a>
				</li>

				<li class="nav-item dropdown" id="avatar">
					<a data-mdb-dropdown-init class="nav-link dropdown-toggle hidden-arrow d-flex align-items-center" href="#" id="navbarDropdownMenuLink" role="button" data-mdb-toggle="dropdown" aria-expanded="false">
							ðŸ‘¤ User
						</a>
					<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink" id="profileMenu">
						<li>
							<a class="dropdown-item" href="#" id="change-password">Change Password</a>
						</li>
						<li>
							<a class="dropdown-item" href="./register.html" id="administration">Administration</a>
						</li>
						<li>
							<a class="dropdown-item" href="#" id="logoutLink">Logout</a>
						</li>
					</ul>
				</li>


				<li class="nav-item">
					<a class="nav-link text-light" href="./login.html" id="loginLink">
							Login
						</a>
				</li>

			</ul>
		</div>
	</div>
</nav>

<div class="container">

	<h1 class="mb-4 mt-5">OEAPI - Courses Overview</h1>

	<!-- University Selector -->
	<div class="mb-4">
		<label for="universitySelect" class="form-label"><strong>Using University Endpoint: </strong></label>
		<select id="universitySelect" class="form-select"></select>
	</div>

	<!-- University Selector -->
	<div class="mb-4">
		<p><strong>Endpoint Security: &nbsp;</strong><span id="epSecurity">Unknown</span></p>
	</div>

	<!-- Level Summary Table -->
	<h3>Course Levels Summary</h3>
	<div class="table-responsive mb-5">
		<table class="table table-bordered table-striped table-primary" id="levels-table">
			<thead class="table-dark">
				<tr>
					<th>Level</th>
					<th>Count</th>
				</tr>
			</thead>
			<tbody>
				<!-- Dynamic rows -->
			</tbody>
		</table>
	</div>

	<!-- Detailed Courses Table -->
	<h3>Course Details</h3>
	<div class="table-responsive">
		<table class="table table-bordered table-hover table-striped table-info" id="courses-table">
			<thead class="table-secondary">
				<tr>
					<th>Course Name</th>
					<th>Level</th>
					<th>Mode of Delivery</th>
				</tr>
			</thead>
			<tbody>
				<!-- Dynamic rows -->
			</tbody>
		</table>
	</div>
</div>

    <script>
	
	$(document).ready(function () {
	
		const selectEl = $('#universitySelect');		
		selectEl.append("<option value=" + ooapiDefaultEndpointURL + " selected >" + ooapiDefaultUnivName + "&nbsp;&nbsp; ( " + ooapiDefaultEndpointURL + " ) </option>");
				
		getJwtSecurityStatus().then(status => {
		   
			document.getElementById("epSecurity").innerHTML=status;
			console.log("JWT security active:", status);
			manageAdminItems();
		});				

		// Load courses for selected university
		function loadCourses(endpoint) {

			console.log("Loading courses from endpoint: " + endpoint);

			const coursesUrl = endpoint + '/courses';
			$.getJSON(coursesUrl, function (data) {
				const courses = Array.isArray(data) ? data : data.items || [];

				// Update levels table
				const levelCounts = {};
				courses.forEach(course => {
					const level = course.level || 'Unknown';
					levelCounts[level] = (levelCounts[level] || 0) + 1;
				});

				const levelTable = $('#levels-table tbody').empty();
				Object.entries(levelCounts).forEach(([level, count]) => {
					levelTable.append("<tr><td>" + level + "</td><td>" + count + "</td></tr>");
				});

				// Update courses table
				const courseTable = $('#courses-table tbody').empty();
				courses.forEach(course => {
					const name = (course.name && course.name[0] && course.name[0].value) || 'Unnamed';
					const level = course.level || 'N/A';
					const modes = (course.modeOfDelivery || []).join(', ') || 'N/A';
					courseTable.append("<tr><td><a href='./course.html?courseId="+course.courseId+"&univ="+ooapiDefaultShortUnivName+"' >" + name + "</a></td><td>" + level + "</td><td>" + modes + "</td></tr>");
				});
			}).fail(function () {
				$('#levels-table tbody, #courses-table tbody').html(
						'<tr><td colspan="3" class="text-danger">Failed to load course data. (Revise Endpoint).</td></tr>'
						);
			});
		}

		// Initial load from default selected university
		loadCourses(selectEl.val());

		// On change, reload
		selectEl.on('change', function () {
			loadCourses(this.value);
		});

		// Attach the event listener using event delegation
		$(document).on('change', '#universitySelect', function () {
			const selectedEndpoint = $(this).val();
			loadCourses(selectedEndpoint);
		});

	});

	document.getElementById("logoutLink").addEventListener("click", function (e) {
			e.preventDefault();
			localStorage.removeItem("jwt");
			window.location.href = "login.html";
		});

    </script>

</body>

</html>